<div class="card">
    <div class="card-header bg-primary text-light">
        Gestión de listas de precios
    </div>

    <dx-load-panel #loadPanel shadingColor="rgba(0,0,0,0.4)" [position]="{ of: '#priceList' }" [(visible)]="loading"
        [showIndicator]="true" [showPane]="true" [shading]="true" [closeOnOutsideClick]="false">
    </dx-load-panel>
    <div id="priceList" class="card-body">
        <form autocomplete="off">
            <dx-data-grid [editing]="editing" [dataSource]="data" [showBorders]="true" [repaintChangesOnly]="true"
                [showColumnLines]="true" [showRowLines]="true" (onRowUpdated)="updatePriceList($event)"
                (onRowInserted)="addPriceList($event)" [showBorders]="true" [rowAlternationEnabled]="true"
                [masterDetail]="{ enabled: true, template: 'detail' }" keyExpr="Lisp_Consec">
                [highlightChanges]="true">
                <dxo-paging [pageSize]="10"></dxo-paging>
                ​<dxo-filter-row [visible]="true"></dxo-filter-row>
                <dxo-header-filter [visible]="true"></dxo-header-filter>
                <dxo-search-panel [visible]="true" [highlightCaseSensitive]="true" [placeholder]="'Buscar'">
                </dxo-search-panel>
                <dxo-editing mode="form" [useIcons]="true" [allowUpdating]="true" [allowDeleting]="true"
                    [confirmDelete]="true" [allowAdding]="true">
                    <dxo-texts deleteRow="Borrar fila" addRow="Añadir" cancelAllChanges="Cancelar cambios"
                        editRow="Editar" saveRowChanges="Guardar" cancelRowChanges="Cancelar">
                    </dxo-texts>
                </dxo-editing>
                <dxi-column dataField="Empr_Codigo" caption="Empresa">
                    <dxo-lookup [dataSource]="businessData" displayExpr="Empr_Nombre" valueExpr="Empr_Codigo">
                    </dxo-lookup>
                    <dxi-validation-rule type="required" message="Empresa requerida requerida">
                    </dxi-validation-rule>
                </dxi-column>
                <dxi-column dataField="Lisp_Codigo" caption="Código" dataType="number">
                    <dxi-validation-rule type="required" message="Código requerido">
                    </dxi-validation-rule>
                    <dxi-validation-rule type="required" message="Código requerido">
                    </dxi-validation-rule>
                </dxi-column>
                <dxi-column dataField="Lisp_Nombre" caption="Nombre" dataType="string">
                    <dxi-validation-rule type="required" message="Nombre requerido">
                    </dxi-validation-rule>
                    <dxi-validation-rule type="required" message="Nombre requerido">
                    </dxi-validation-rule>
                </dxi-column>
                <dxi-column dataField="Sucu_Consec" caption="Sucursal">
                    <dxo-lookup [dataSource]="branchData" displayExpr="Sucu_Nombre" valueExpr="Sucu_Consec">
                    </dxo-lookup>
                    <dxi-validation-rule type="required" message="Sucursal requerida">
                    </dxi-validation-rule>
                </dxi-column>
                <dxi-column dataField="Lisp_Estado" caption="Estado">
                    <dxi-validation-rule type="required" message="Estado requerido">
                    </dxi-validation-rule>
                    <dxo-lookup [dataSource]="[  { value:'I','text':'Inactivo' }, {  value:'A', text:'Activo'}]"
                        displayExpr="text" valueExpr="value">
                    </dxo-lookup>
                </dxi-column>
                <div *dxTemplate="let movement of 'detail'">

                    <dx-data-grid (onRowUpdated)="updatePriceListDetail($event)"
                    (onRowInserted)="addPriceListDetail($event,movement.data)" [dataSource]="movement.data.details" [showBorders]="true" [columnAutoWidth]="true"
                        [showColumnLines]="true"  [editing]="editing" [repaintChangesOnly]="true" [showRowLines]="true" [rowAlternationEnabled]="true"  [highlightChanges]="true">
                        <dxo-filter-row [visible]="true"></dxo-filter-row>
                        <dxo-header-filter [visible]="true"></dxo-header-filter>
                        <dxo-editing mode="form" [useIcons]="true" [allowUpdating]="true" [allowDeleting]="true"
                    [confirmDelete]="true" [allowAdding]="true">
                    <dxo-texts deleteRow="Borrar fila" addRow="Añadir" cancelAllChanges="Cancelar cambios"
                        editRow="Editar" saveRowChanges="Guardar" cancelRowChanges="Cancelar">
                    </dxo-texts>
                </dxo-editing>
                        <dxi-column dataField="Prod_Consec" caption="Producto" dataType="text">
                            <dxo-lookup
                            [dataSource]="productData"
                            displayExpr="prod_nombre" 
                            valueExpr="prod_consec">
                        </dxo-lookup>
                        </dxi-column>
                        <dxi-column dataField="Dlis_Valor" caption="Valor" dataType="number" [editorOptions]="{ format: '$ #,##0.##' }"></dxi-column>
                        <dxi-column dataField="Dlis_Valimp" caption="Impuestos" dataType="number" [editorOptions]="{ format: '$ #,##0.##' }"></dxi-column>
                        <dxi-column
                        dataField="Dlis_Estado"
                        caption="Estado"  >   
                        <dxi-validation-rule 
                        type="required"
                        message="Estado requerido">
                    </dxi-validation-rule>      
                        <dxo-lookup
                            [dataSource]="[  { value:'I','text':'Inactivo' }, {  value:'A', text:'Activo'}]"
                            displayExpr="text" 
                            valueExpr="value">
                        </dxo-lookup>
                    </dxi-column>                       
                    </dx-data-grid>
                </div>
            </dx-data-grid>
        </form>
    </div>


</div>
<ngb-alert *ngIf="successMessage" [type]="'success'" (close)="successMessage = null">{{ successMessage }}</ngb-alert>